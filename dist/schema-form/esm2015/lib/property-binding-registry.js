import { __decorate } from "tslib";
import { Injectable } from "@angular/core";
/**
 * General purpose propery binding registry
 */
let PropertyBindingRegistry = class PropertyBindingRegistry {
    constructor() {
        this.bindings = {};
    }
    getPropertyBindings(type) {
        this.bindings[type] = this.bindings[type] || new PropertyBindings();
        return this.bindings[type];
    }
    getPropertyBindingsVisibility() {
        return this.getPropertyBindings(PropertyBindingTypes.visibility);
    }
};
PropertyBindingRegistry = __decorate([
    Injectable()
], PropertyBindingRegistry);
export { PropertyBindingRegistry };
/**
 * Defines the types of supported property bindings.<br/>
 * For now only <code>visibility</code> is supported.<br/>
 */
export var PropertyBindingTypes;
(function (PropertyBindingTypes) {
    PropertyBindingTypes[PropertyBindingTypes["visibility"] = 0] = "visibility";
})(PropertyBindingTypes || (PropertyBindingTypes = {}));
/**
 * Storage that holds all bindings that are property paths related.<br/>
 */
export class PropertyBindings {
    constructor() {
        this.sourcesIndex = new SimplePropertyIndexer();
        this.dependenciesIndex = new SimplePropertyIndexer();
    }
    add(dependencyPath, sourcePropertyPath) {
        this.sourcesIndex.store(sourcePropertyPath, dependencyPath);
        this.dependenciesIndex.store(dependencyPath, sourcePropertyPath);
    }
    findByDependencyPath(dependencyPath) {
        const result = this.dependenciesIndex.find(dependencyPath);
        result.results = result.results || [];
        let values = [];
        for (const res of result.results) {
            values = values.concat(Object.keys(res.value));
        }
        return result.found ? values : [];
    }
    getBySourcePropertyPath(sourcePropertyPath) {
        const result = this.sourcesIndex.find(sourcePropertyPath);
        result.results = result.results || [];
        let values = [];
        for (const res of result.results) {
            values = values.concat(Object.keys(res.value));
        }
        return result.found ? values : [];
    }
    createPathIndex(path) {
        return path.split('/');
    }
}
/**
 * Simple indexer to store property paths
 */
export class SimplePropertyIndexer {
    constructor() {
        this.index = {};
        this.findOnlyWithValue = true;
    }
    _createPathIndex(path) {
        return path
            .replace(new RegExp('//', 'g'), '/')
            .replace(new RegExp('^/', 'g'), '')
            .split('/').filter(item => item);
    }
    store(propertyPath, value) {
        this._storeIndex(this._createPathIndex(propertyPath), value);
    }
    _storeIndex(pathIndex, value) {
        let indexPos = this.index;
        for (const key of pathIndex) {
            indexPos[key] = indexPos[key] || {};
            indexPos = indexPos[key];
        }
        if (indexPos && value) {
            indexPos[SimplePropertyIndexer.MARKER] = indexPos[SimplePropertyIndexer.MARKER] || {};
            indexPos[SimplePropertyIndexer.MARKER][value] = value;
        }
    }
    /**
     * Find path in index.<br/>
     * Will find path like:<br/>
     * <ul>
     *     <li>/property/0/prop</li>
     *     <li>/property/0/prop/2/test</li>
     *     <li>/property/0/prop/&#42;/test</li>
     *     <li>/property/&#42;/prop/1/test</li>
     *     <li>/property/&#42;/prop/&#42;/test</li>
     *     <li>/property/1/prop/&#42;/test</li>
     *  </ul>
     * @param path
     */
    find(path) {
        return this._findInIndex(this._createPathIndex(path));
    }
    _findInIndex(path) {
        const ixRes = { target: path, found: false, results: [] };
        this.__findIndex(ixRes, path, this.index, []);
        return ixRes;
    }
    __findIndex(indexerResults, path, index, parent) {
        const p = parent || [];
        const segment = path[0];
        const wild = ('*' === segment) ? Object.keys(index) : [];
        const _keys = (Array.isArray(segment) ? segment : [segment]).concat(wild);
        const keys = _keys.filter((item, pos) => '*' !== item && _keys.indexOf(item) === pos); // remove duplicates
        if (index['*']) {
            keys.push('*');
        }
        let paths = [];
        for (const key of keys) {
            const restPath = path.slice(1);
            const restIndex = index[key];
            const restParent = p.concat(key);
            if (path.length === 1) { // collect only the full paths
                if (!this.findOnlyWithValue || (restIndex && restIndex[SimplePropertyIndexer.MARKER])) {
                    indexerResults.results = indexerResults.results || [];
                    indexerResults.results.push({
                        path: restParent,
                        value: restIndex[SimplePropertyIndexer.MARKER]
                    });
                    paths.push(restParent);
                    indexerResults.found = indexerResults.results.length > 0;
                }
            }
            if (!restPath || !restPath.length || !restIndex) {
                break;
            }
            const restPaths = this.__findIndex(indexerResults, restPath, restIndex, restParent);
            paths = paths.concat(restPaths);
        }
        return paths;
    }
}
SimplePropertyIndexer.MARKER = '$____value';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvcGVydHktYmluZGluZy1yZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1zY2hlbWEtZm9ybS8iLCJzb3VyY2VzIjpbImxpYi9wcm9wZXJ0eS1iaW5kaW5nLXJlZ2lzdHJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDOztHQUVHO0FBRUgsSUFBYSx1QkFBdUIsR0FBcEMsTUFBYSx1QkFBdUI7SUFBcEM7UUFFVSxhQUFRLEdBQXdDLEVBQUUsQ0FBQztJQVU3RCxDQUFDO0lBUkMsbUJBQW1CLENBQUMsSUFBMEI7UUFDNUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztRQUNwRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELDZCQUE2QjtRQUMzQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuRSxDQUFDO0NBQ0YsQ0FBQTtBQVpZLHVCQUF1QjtJQURuQyxVQUFVLEVBQUU7R0FDQSx1QkFBdUIsQ0FZbkM7U0FaWSx1QkFBdUI7QUFjcEM7OztHQUdHO0FBQ0gsTUFBTSxDQUFOLElBQVksb0JBRVg7QUFGRCxXQUFZLG9CQUFvQjtJQUM5QiwyRUFBVSxDQUFBO0FBQ1osQ0FBQyxFQUZXLG9CQUFvQixLQUFwQixvQkFBb0IsUUFFL0I7QUFFRDs7R0FFRztBQUNILE1BQU0sT0FBTyxnQkFBZ0I7SUFBN0I7UUFDRSxpQkFBWSxHQUEwQixJQUFJLHFCQUFxQixFQUFFLENBQUM7UUFDbEUsc0JBQWlCLEdBQTBCLElBQUkscUJBQXFCLEVBQUUsQ0FBQztJQThCekUsQ0FBQztJQTVCQyxHQUFHLENBQUMsY0FBc0IsRUFBRSxrQkFBMEI7UUFDcEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsb0JBQW9CLENBQUMsY0FBc0I7UUFDekMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUMzRCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO1FBQ3RDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNoQixLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDaEMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUVELHVCQUF1QixDQUFDLGtCQUEwQjtRQUNoRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzFELE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDdEMsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUNoQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ2hEO1FBQ0QsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRUQsZUFBZSxDQUFDLElBQVk7UUFDMUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7Q0FDRjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHFCQUFxQjtJQUFsQztRQUdFLFVBQUssR0FBVyxFQUFFLENBQUM7UUFDbkIsc0JBQWlCLEdBQUcsSUFBSSxDQUFDO0lBd0YzQixDQUFDO0lBdEZTLGdCQUFnQixDQUFDLElBQVk7UUFDbkMsT0FBTyxJQUFJO2FBQ1IsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUM7YUFDbkMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUM7YUFDbEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxLQUFLLENBQUMsWUFBb0IsRUFBRSxLQUFXO1FBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFTyxXQUFXLENBQUMsU0FBbUIsRUFBRSxLQUFjO1FBQ3JELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDMUIsS0FBSyxNQUFNLEdBQUcsSUFBSSxTQUFTLEVBQUU7WUFDM0IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDcEMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQjtRQUNELElBQUksUUFBUSxJQUFJLEtBQUssRUFBRTtZQUNyQixRQUFRLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLEdBQUcsUUFBUSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN0RixRQUFRLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQ3ZEO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7T0FZRztJQUNILElBQUksQ0FBQyxJQUFZO1FBQ2YsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRCxZQUFZLENBQUMsSUFBYztRQUN6QixNQUFNLEtBQUssR0FBa0IsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFdBQVcsQ0FBQyxjQUE2QixFQUFFLElBQWMsRUFBRSxLQUFhLEVBQUUsTUFBaUI7UUFFekYsTUFBTSxDQUFDLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUN2QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUN6RCxNQUFNLEtBQUssR0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLElBQUksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsb0JBQW9CO1FBRTNHLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQjtRQUVELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNmLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0IsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sVUFBVSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFakMsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxFQUFDLDhCQUE4QjtnQkFDcEQsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRTtvQkFDckYsY0FBYyxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztvQkFDdEQsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7d0JBQzFCLElBQUksRUFBRSxVQUFVO3dCQUNoQixLQUFLLEVBQUUsU0FBUyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQztxQkFDL0MsQ0FBQyxDQUFDO29CQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ3ZCLGNBQWMsQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2lCQUMxRDthQUNGO1lBRUQsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQy9DLE1BQU07YUFDUDtZQUNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFFcEYsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDakM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O0FBeEZNLDRCQUFNLEdBQUcsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG4vKipcbiAqIEdlbmVyYWwgcHVycG9zZSBwcm9wZXJ5IGJpbmRpbmcgcmVnaXN0cnlcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByb3BlcnR5QmluZGluZ1JlZ2lzdHJ5IHtcblxuICBwcml2YXRlIGJpbmRpbmdzOiB7IFtrZXk6IHN0cmluZ106IFByb3BlcnR5QmluZGluZ3MgfSA9IHt9O1xuXG4gIGdldFByb3BlcnR5QmluZGluZ3ModHlwZTogUHJvcGVydHlCaW5kaW5nVHlwZXMpOiBQcm9wZXJ0eUJpbmRpbmdzIHtcbiAgICB0aGlzLmJpbmRpbmdzW3R5cGVdID0gdGhpcy5iaW5kaW5nc1t0eXBlXSB8fCBuZXcgUHJvcGVydHlCaW5kaW5ncygpO1xuICAgIHJldHVybiB0aGlzLmJpbmRpbmdzW3R5cGVdO1xuICB9XG5cbiAgZ2V0UHJvcGVydHlCaW5kaW5nc1Zpc2liaWxpdHkoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHlCaW5kaW5ncyhQcm9wZXJ0eUJpbmRpbmdUeXBlcy52aXNpYmlsaXR5KTtcbiAgfVxufVxuXG4vKipcbiAqIERlZmluZXMgdGhlIHR5cGVzIG9mIHN1cHBvcnRlZCBwcm9wZXJ0eSBiaW5kaW5ncy48YnIvPlxuICogRm9yIG5vdyBvbmx5IDxjb2RlPnZpc2liaWxpdHk8L2NvZGU+IGlzIHN1cHBvcnRlZC48YnIvPlxuICovXG5leHBvcnQgZW51bSBQcm9wZXJ0eUJpbmRpbmdUeXBlcyB7XG4gIHZpc2liaWxpdHlcbn1cblxuLyoqXG4gKiBTdG9yYWdlIHRoYXQgaG9sZHMgYWxsIGJpbmRpbmdzIHRoYXQgYXJlIHByb3BlcnR5IHBhdGhzIHJlbGF0ZWQuPGJyLz5cbiAqL1xuZXhwb3J0IGNsYXNzIFByb3BlcnR5QmluZGluZ3Mge1xuICBzb3VyY2VzSW5kZXg6IFNpbXBsZVByb3BlcnR5SW5kZXhlciA9IG5ldyBTaW1wbGVQcm9wZXJ0eUluZGV4ZXIoKTtcbiAgZGVwZW5kZW5jaWVzSW5kZXg6IFNpbXBsZVByb3BlcnR5SW5kZXhlciA9IG5ldyBTaW1wbGVQcm9wZXJ0eUluZGV4ZXIoKTtcblxuICBhZGQoZGVwZW5kZW5jeVBhdGg6IHN0cmluZywgc291cmNlUHJvcGVydHlQYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNvdXJjZXNJbmRleC5zdG9yZShzb3VyY2VQcm9wZXJ0eVBhdGgsIGRlcGVuZGVuY3lQYXRoKTtcbiAgICB0aGlzLmRlcGVuZGVuY2llc0luZGV4LnN0b3JlKGRlcGVuZGVuY3lQYXRoLCBzb3VyY2VQcm9wZXJ0eVBhdGgpO1xuICB9XG5cbiAgZmluZEJ5RGVwZW5kZW5jeVBhdGgoZGVwZW5kZW5jeVBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmRlcGVuZGVuY2llc0luZGV4LmZpbmQoZGVwZW5kZW5jeVBhdGgpO1xuICAgIHJlc3VsdC5yZXN1bHRzID0gcmVzdWx0LnJlc3VsdHMgfHwgW107XG4gICAgbGV0IHZhbHVlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgcmVzIG9mIHJlc3VsdC5yZXN1bHRzKSB7XG4gICAgICB2YWx1ZXMgPSB2YWx1ZXMuY29uY2F0KE9iamVjdC5rZXlzKHJlcy52YWx1ZSkpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0LmZvdW5kID8gdmFsdWVzIDogW107XG4gIH1cblxuICBnZXRCeVNvdXJjZVByb3BlcnR5UGF0aChzb3VyY2VQcm9wZXJ0eVBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnNvdXJjZXNJbmRleC5maW5kKHNvdXJjZVByb3BlcnR5UGF0aCk7XG4gICAgcmVzdWx0LnJlc3VsdHMgPSByZXN1bHQucmVzdWx0cyB8fCBbXTtcbiAgICBsZXQgdmFsdWVzID0gW107XG4gICAgZm9yIChjb25zdCByZXMgb2YgcmVzdWx0LnJlc3VsdHMpIHtcbiAgICAgIHZhbHVlcyA9IHZhbHVlcy5jb25jYXQoT2JqZWN0LmtleXMocmVzLnZhbHVlKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQuZm91bmQgPyB2YWx1ZXMgOiBbXTtcbiAgfVxuXG4gIGNyZWF0ZVBhdGhJbmRleChwYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHBhdGguc3BsaXQoJy8nKTtcbiAgfVxufVxuXG4vKipcbiAqIFNpbXBsZSBpbmRleGVyIHRvIHN0b3JlIHByb3BlcnR5IHBhdGhzXG4gKi9cbmV4cG9ydCBjbGFzcyBTaW1wbGVQcm9wZXJ0eUluZGV4ZXIge1xuXG4gIHN0YXRpYyBNQVJLRVIgPSAnJF9fX192YWx1ZSc7XG4gIGluZGV4OiBvYmplY3QgPSB7fTtcbiAgZmluZE9ubHlXaXRoVmFsdWUgPSB0cnVlO1xuXG4gIHByaXZhdGUgX2NyZWF0ZVBhdGhJbmRleChwYXRoOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aFxuICAgICAgLnJlcGxhY2UobmV3IFJlZ0V4cCgnLy8nLCAnZycpLCAnLycpXG4gICAgICAucmVwbGFjZShuZXcgUmVnRXhwKCdeLycsICdnJyksICcnKVxuICAgICAgLnNwbGl0KCcvJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG4gIH1cblxuICBzdG9yZShwcm9wZXJ0eVBhdGg6IHN0cmluZywgdmFsdWU/OiBhbnkpIHtcbiAgICB0aGlzLl9zdG9yZUluZGV4KHRoaXMuX2NyZWF0ZVBhdGhJbmRleChwcm9wZXJ0eVBhdGgpLCB2YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIF9zdG9yZUluZGV4KHBhdGhJbmRleDogc3RyaW5nW10sIHZhbHVlPzogc3RyaW5nKSB7XG4gICAgbGV0IGluZGV4UG9zID0gdGhpcy5pbmRleDtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBwYXRoSW5kZXgpIHtcbiAgICAgIGluZGV4UG9zW2tleV0gPSBpbmRleFBvc1trZXldIHx8IHt9O1xuICAgICAgaW5kZXhQb3MgPSBpbmRleFBvc1trZXldO1xuICAgIH1cbiAgICBpZiAoaW5kZXhQb3MgJiYgdmFsdWUpIHtcbiAgICAgIGluZGV4UG9zW1NpbXBsZVByb3BlcnR5SW5kZXhlci5NQVJLRVJdID0gaW5kZXhQb3NbU2ltcGxlUHJvcGVydHlJbmRleGVyLk1BUktFUl0gfHwge307XG4gICAgICBpbmRleFBvc1tTaW1wbGVQcm9wZXJ0eUluZGV4ZXIuTUFSS0VSXVt2YWx1ZV0gPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmluZCBwYXRoIGluIGluZGV4Ljxici8+XG4gICAqIFdpbGwgZmluZCBwYXRoIGxpa2U6PGJyLz5cbiAgICogPHVsPlxuICAgKiAgICAgPGxpPi9wcm9wZXJ0eS8wL3Byb3A8L2xpPlxuICAgKiAgICAgPGxpPi9wcm9wZXJ0eS8wL3Byb3AvMi90ZXN0PC9saT5cbiAgICogICAgIDxsaT4vcHJvcGVydHkvMC9wcm9wLyYjNDI7L3Rlc3Q8L2xpPlxuICAgKiAgICAgPGxpPi9wcm9wZXJ0eS8mIzQyOy9wcm9wLzEvdGVzdDwvbGk+XG4gICAqICAgICA8bGk+L3Byb3BlcnR5LyYjNDI7L3Byb3AvJiM0MjsvdGVzdDwvbGk+XG4gICAqICAgICA8bGk+L3Byb3BlcnR5LzEvcHJvcC8mIzQyOy90ZXN0PC9saT5cbiAgICogIDwvdWw+XG4gICAqIEBwYXJhbSBwYXRoXG4gICAqL1xuICBmaW5kKHBhdGg6IHN0cmluZyk6IEluZGV4ZXJSZXN1bHQge1xuICAgIHJldHVybiB0aGlzLl9maW5kSW5JbmRleCh0aGlzLl9jcmVhdGVQYXRoSW5kZXgocGF0aCkpO1xuICB9XG5cbiAgX2ZpbmRJbkluZGV4KHBhdGg6IHN0cmluZ1tdKTogSW5kZXhlclJlc3VsdCB7XG4gICAgY29uc3QgaXhSZXM6IEluZGV4ZXJSZXN1bHQgPSB7dGFyZ2V0OiBwYXRoLCBmb3VuZDogZmFsc2UsIHJlc3VsdHM6IFtdfTtcbiAgICB0aGlzLl9fZmluZEluZGV4KGl4UmVzLCBwYXRoLCB0aGlzLmluZGV4LCBbXSk7XG4gICAgcmV0dXJuIGl4UmVzO1xuICB9XG5cbiAgX19maW5kSW5kZXgoaW5kZXhlclJlc3VsdHM6IEluZGV4ZXJSZXN1bHQsIHBhdGg6IHN0cmluZ1tdLCBpbmRleDogb2JqZWN0LCBwYXJlbnQ/OiBzdHJpbmdbXSkge1xuXG4gICAgY29uc3QgcCA9IHBhcmVudCB8fCBbXTtcbiAgICBjb25zdCBzZWdtZW50ID0gcGF0aFswXTtcbiAgICBjb25zdCB3aWxkID0gKCcqJyA9PT0gc2VnbWVudCkgPyBPYmplY3Qua2V5cyhpbmRleCkgOiBbXTtcbiAgICBjb25zdCBfa2V5cyA9ICgoQXJyYXkuaXNBcnJheShzZWdtZW50KSA/IHNlZ21lbnQgOiBbc2VnbWVudF0pIGFzIHN0cmluZ1tdKS5jb25jYXQod2lsZCk7XG4gICAgY29uc3Qga2V5cyA9IF9rZXlzLmZpbHRlcigoaXRlbSwgcG9zKSA9PiAnKicgIT09IGl0ZW0gJiYgX2tleXMuaW5kZXhPZihpdGVtKSA9PT0gcG9zKTsgLy8gcmVtb3ZlIGR1cGxpY2F0ZXNcblxuICAgIGlmIChpbmRleFsnKiddKSB7XG4gICAgICBrZXlzLnB1c2goJyonKTtcbiAgICB9XG5cbiAgICBsZXQgcGF0aHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBjb25zdCByZXN0UGF0aCA9IHBhdGguc2xpY2UoMSk7XG4gICAgICBjb25zdCByZXN0SW5kZXggPSBpbmRleFtrZXldO1xuICAgICAgY29uc3QgcmVzdFBhcmVudCA9IHAuY29uY2F0KGtleSk7XG5cbiAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMSkgey8vIGNvbGxlY3Qgb25seSB0aGUgZnVsbCBwYXRoc1xuICAgICAgICBpZiAoIXRoaXMuZmluZE9ubHlXaXRoVmFsdWUgfHwgKHJlc3RJbmRleCAmJiByZXN0SW5kZXhbU2ltcGxlUHJvcGVydHlJbmRleGVyLk1BUktFUl0pKSB7XG4gICAgICAgICAgaW5kZXhlclJlc3VsdHMucmVzdWx0cyA9IGluZGV4ZXJSZXN1bHRzLnJlc3VsdHMgfHwgW107XG4gICAgICAgICAgaW5kZXhlclJlc3VsdHMucmVzdWx0cy5wdXNoKHtcbiAgICAgICAgICAgIHBhdGg6IHJlc3RQYXJlbnQsXG4gICAgICAgICAgICB2YWx1ZTogcmVzdEluZGV4W1NpbXBsZVByb3BlcnR5SW5kZXhlci5NQVJLRVJdXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF0aHMucHVzaChyZXN0UGFyZW50KTtcbiAgICAgICAgICBpbmRleGVyUmVzdWx0cy5mb3VuZCA9IGluZGV4ZXJSZXN1bHRzLnJlc3VsdHMubGVuZ3RoID4gMDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIXJlc3RQYXRoIHx8ICFyZXN0UGF0aC5sZW5ndGggfHwgIXJlc3RJbmRleCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3RQYXRocyA9IHRoaXMuX19maW5kSW5kZXgoaW5kZXhlclJlc3VsdHMsIHJlc3RQYXRoLCByZXN0SW5kZXgsIHJlc3RQYXJlbnQpO1xuXG4gICAgICBwYXRocyA9IHBhdGhzLmNvbmNhdChyZXN0UGF0aHMpO1xuICAgIH1cbiAgICByZXR1cm4gcGF0aHM7XG4gIH1cblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEluZGV4ZXJSZXN1bHQge1xuICAvKipcbiAgICogVGhlIHBhdGggb3JpZ2luYWxseSBzZWFyY2hlZCBmb3JcbiAgICovXG4gIHRhcmdldDogc3RyaW5nW107XG4gIC8qKlxuICAgKiBGbGFnIGZvciB0aGUgc3RhdHVzIG9mIGZvdW5kIG9yIG5vdCBmb3VuZC48YnIvPlxuICAgKiBVc3VhbGx5IDxjb2RlPnJlc3VsdHM8L2NvZGU+IHdpbGwgYmUgZW1wdHkgaWYgbm8gbWF0Y2hlcyBmb3VuZC5cbiAgICovXG4gIGZvdW5kOiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIHJlc3VsdCBwYXRoIGFuZCB2YWx1ZXMgZnJvbSB0aGUgaW5kZXggc2VhcmNoLjxici8+XG4gICAqIFVzdWFsbHkgPGNvZGU+cmVzdWx0czwvY29kZT4gd2lsbCBiZSBlbXB0eSBpZiBubyBtYXRjaGVzIGZvdW5kLlxuICAgKi9cbiAgcmVzdWx0czoge1xuICAgIC8qKlxuICAgICAqIFRoZSBwYXRoIHRoYXQgbWF0Y2hlZCB0aGUgPGNvZGU+dGFyZ2V0PC9jb2RlPlxuICAgICAqIHNlcGFyYXRlZCBpbiBzZWdtZW50c1xuICAgICAqL1xuICAgIHBhdGg6IHN0cmluZ1tdLFxuICAgIC8qKlxuICAgICAqIFRoZSB2YWx1ZSBzdG9yZWQgYXQgdGhlIDxjb2RlPnBhdGg8L2NvZGU+XG4gICAgICovXG4gICAgdmFsdWU6IGFueVxuICB9W107XG59XG4iXX0=